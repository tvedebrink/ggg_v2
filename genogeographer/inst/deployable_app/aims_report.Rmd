---
title: "AIMs profile analysis"
params:
  set_file: "file_name"
  set_author: "author_name"
  set_output: "HTML"
  set_locus: "Target.ID"
  set_genotype: "Genotype"
  set_db: "db"
---

---
author: `r params$set_author`
date: `r format(Sys.time(), "%a %b %d %X %Y")`
---

```{r, echo=FALSE, include=FALSE}
dt_table <- function(x, ...){
  x %>%
    DT::datatable(data = ., ...,
                  rownames=FALSE, filter = "bottom", selection = 'none',
                  extensions = 'Buttons',
                  options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                    lengthMenu = list(c(10, 25, 50, 100, -1), c("10", "25", "50", "100", "All"))
                  )
    )
}

# params <- list(
#   #set_file = "file_name",
#   set_author = "author_name",
#   set_output = "HTML",
#   set_locus = "Target.ID",
#   set_genotype = "Genotype",
#   set_db = "db",
#   set_date = "date"
# )
```

# File report: `r params$set_file`

```{r setup, include=FALSE}
ggg_package <- "genogeographerDEVEL"

knitr::opts_chunk$set(echo = FALSE, comment = NA, message = FALSE, warning = FALSE, fig.width = 8, fig.asp = 0.6, error = TRUE, fig.align = 'center')
library(knitr)
library(DT)
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(tibble)
library(purrr)
library(leaflet)
library(forcats)
theme_set(theme_bw(base_size = 14))
```



```{r result}
res <- reactive_result()
LR_Tab <- reactive_LR_table()
```

This is an autogenerated report from `r ggg_package` version `r packageVersion(ggg_package)`.

The report contains outputs from meta and specific populations. The analysed genotype is in the appendix.

## Tables

```{r}
z_table()

LR_list(result = LR_Tab$res, LR_tab = LR_Tab$LR_Tab)
```

## Map

```{r, fig.asp=0.8}
plot_map()
```

## Plots

### Error bar plots

```{r errorbar_plot, fig.cap="Errorbar plot, where the bars reflects approximate confidence interval"}
error_bar_plotly(res) %>% 
  ggplotly(tooltip = c("text")) %>%
  layout(showlegend = FALSE) %>%
  config(displayModeBar = FALSE)
```

### LR plots

```{r}
LR_plot_ly(result = LR_Tab$res, LR_list = LR_Tab$LR_Tab)
```

# Appendix {.tabset}

## `r params$set_file`

Use tabs to see the profiles

## Uploaded profile

```{r}
reactive_read_profile() %>% dt_table()
```

## Analysed profile

```{r}
raw_profile <- reactive_read_profile() %>% rename(locus = params$set_locus)
profile <- reactive_profile()
profile_drop <- raw_profile %>% anti_join(profile, by = "locus") %>%
  rename(!!sym(params$set_locus) := locus)
profile_x0 <- raw_profile %>% semi_join(profile, by = "locus") %>% 
  rename(!!sym(params$set_locus) := locus)
```

### Analysed loci

The loci below has been included in the analysis.

```{r}
profile_x0 %>% dt_table()
```

### Dropped or unused loci

The loci below has been excluded from the analysis. Either because of state 'NN', locus not in `r params$set_db`
or other typing error (e.g. different reference allele).
```{r}      
profile_drop %>% dt_table()
```

